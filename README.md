fmperf repository: https://github.com/fmperf-project/fmperf

# Setup

Set your preferences in the .env file. The ones that require closer atention are:
- Duration: Specify the amount of time (in seconds) of each iteration
- URL: Specify the port where the model is deployed

The values MAX/MIN_INPUT/OUTPUT_TOKENS will automatically change between iterations.

The value REQ_MIN will automatically change between iterations.

The way in which these values change is described and set in the experiment_automation.py file:
- At the end of the file, you will find a list where the input/output token combinations can be found. This determines the values that MAX/MIN_INPUT/OUTPUT_TOKENS adopt.
- In line 130, you will find the logic behind the change in REQ_MIN (currently exponential growth). This determines the value that REQ_MIN adopts.
- In line 184, you will find the starting value of req_min. Set this to the value that you desire.
- In line 109, you will find a method called "end_experiment" that determines the logic behind the end of the experiment. As it is right now, the experiment ends if the differnce between M and m in the binary search is lower than or equal to 0.5.

# How to run

Once everything is set up, run experiment_automation.py. experiment_automation.slurm creates a SLURM job that executes the experiment in the background.

# Results

The results can be found in the folder /requests, under the name XXX_YYY, where XXX is the number of input tokens of the iteration and YYY is the number of output tokens of the iteration. Within these folders, you will find more folders with the timestamp of each iteration. Finally, here you will find "first_half.csv", "second_half.csv", "output.csv", "results.csv" and "results.json". "first_half.csv" and "second_half.csv" is a summary of the response time of tokens generated in the first and second halves of the experiment, and "output.csv" is the file from which these two are obtained. "results.json" is the standard output of fmperf, where you can find information per token generated. Finally, "results.csv" is a summary of the results obtained from the iteration, although a few of the attributes found in this file are deprecated and would only be of use in our HPC, the most relevant ones are "INPUT_TOKENS", "OUTPUT_TOKENS", "EVALUATION" and "REQ_MIN"; EVALUATION is True if the iteration is deemed sustainable.

# How it works

The experiment consists of a set of iterations. During an iteration, of a specified duration, a number of requests will be sent per minute. The number of requests depends on the value of REQ_MIN. 

The experiment consists of two stages:

## Find non-sustainable value
REQ_MIN starts at a low value, and is increased gradually between iterations. At the end of each iteration, we use the code in /requests/evaluate.py to determine if the iteration is sustainable or not. As long as the iterations performed are sustainable, we continue to increase REQ_MIN. As soon as one of them is not sustainable, this stage ends.

## Find MST
We set _m_ to the highest stable value for REQ_MIN and _M_ to the found unsustainable value of REQ_MIN. A binary search is performed, where REQ_MIN is set to the in-between value of _M_ and _m_ and we run an iteration. We evaluate the result, and update _m_ or _M_ accordinly, based on if the value is deemed sustainable or not. This stage ends once _M_ and _m_ are smaller than a given value (by default this value is 0.5).

## More information

Here you will find a few more pieces of information regarding how the experiment is handled:

### What is the prompt?
The prompt is generated by fmperf, by running the command fmperf.loadgen.generate-input, which is automatically run in the experiment_automation.py file. The prompt takes tokens from the "/fmperf/data/ai.txt" file. The number of tokens is determined by the values MAX/MIN_INPUT_TOKENS.

### Why do I see empty folders with names such as 128_128?
These are placeholder folders where the results of the experiment are stored before being moved to their corresponding location within the /requests folder.